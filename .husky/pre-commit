#!/bin/bash
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# Portable Pre-Commit Hook for ESLint Validation
# =============================================================================
# This hook works across different environments:
# - Native Linux/macOS terminals
# - WSL (Windows Subsystem for Linux)
# - Git Bash on Windows
# - GitHub Codespaces
# - Docker containers
# =============================================================================

# Change to project directory
cd "$(dirname "$0")/.."

echo "ğŸ” PRE-COMMIT VALIDATION"
echo "========================"
echo "Environment: $(uname -s 2>/dev/null || echo 'Unknown')"
echo ""

# Function to find and test npm
find_npm() {
    # Method 1: Try npm directly (works in most environments)
    if command -v npm >/dev/null 2>&1; then
        echo "npm"
        return 0
    fi
    
    # Method 2: Try common absolute paths
    for npm_path in "/usr/bin/npm" "/usr/local/bin/npm" "/opt/homebrew/bin/npm"; do
        if [ -f "$npm_path" ] && [ -x "$npm_path" ]; then
            echo "$npm_path"
            return 0
        fi
    done
    
    # Method 3: Try Windows paths (for Git Bash)
    for npm_path in "/c/Program Files/nodejs/npm.cmd" "/c/nodejs/npm.cmd"; do
        if [ -f "$npm_path" ]; then
            echo "$npm_path"
            return 0
        fi
    done
    
    # Method 4: Try WSL from Git Bash (Windows)
    if command -v wsl >/dev/null 2>&1; then
        # Test if WSL can run npm
        if wsl -e bash -c "command -v npm" >/dev/null 2>&1; then
            echo "wsl_npm"
            return 0
        fi
    fi
    
    return 1
}

# Find npm command
NPM_CMD=$(find_npm)
if [ $? -ne 0 ]; then
    echo "âŒ ERROR: npm not found in any supported environment"
    echo ""
    echo "Please ensure Node.js and npm are installed:"
    echo ""
    echo "ğŸ“‹ Installation Options:"
    echo "  â€¢ Linux/WSL: sudo apt install nodejs npm"
    echo "  â€¢ macOS: brew install node"
    echo "  â€¢ Windows: Download from https://nodejs.org"
    echo "  â€¢ Or use Node Version Manager (nvm)"
    echo ""
    echo "ğŸ’¡ After installation, restart your terminal and try again."
    echo "ğŸ’¡ You can also run the setup script: ./setup.sh"
    echo ""
    exit 1
fi

echo "âœ… Found npm: $NPM_CMD"
echo ""

# Run lint-staged based on environment
case "$NPM_CMD" in
    "wsl_npm")
        echo "ğŸ”„ Running via WSL (Git Bash detected)..."
        # Use current directory path instead of hardcoded path
        CURRENT_DIR=$(pwd)
        WSL_PATH=$(echo "$CURRENT_DIR" | sed 's|^/mnt/c|/c|' | sed 's|^/c|/mnt/c|')
        wsl -e bash -c "cd '$WSL_PATH' && npx lint-staged"
        ;;
    *)
        echo "ğŸ”„ Running lint-staged validation..."
        npx lint-staged
        ;;
esac
