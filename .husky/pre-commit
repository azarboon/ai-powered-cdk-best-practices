#!/bin/bash
. "$(dirname -- "$0")/_/husky.sh"

# Change to project directory
cd "$(dirname "$0")/.."

# Function to find npm/npx
find_npm() {
    if command -v npx >/dev/null 2>&1; then
        echo "npx"
        return 0
    fi
    if command -v npm >/dev/null 2>&1; then
        echo "npm"
        return 0
    fi
    if command -v wsl >/dev/null 2>&1; then
        if wsl -e bash -c "command -v npx" >/dev/null 2>&1; then
            echo "wsl_npx"
            return 0
        fi
    fi
    return 1
}

# Find command
CMD=$(find_npm)
if [ $? -ne 0 ]; then
    echo "‚ùå ERROR: npm/npx not found"
    exit 1
fi

echo "‚ö° Ultra-fast pre-commit validation..."

# Run lint-staged with 10-second timeout for ultra-fast failure
case "$CMD" in
    "npx")
        timeout 10s npx lint-staged
        ;;
    "npm")
        timeout 10s npm run lint-staged
        ;;
    "wsl_npx")
        CURRENT_DIR=$(pwd)
        WSL_PATH=$(echo "$CURRENT_DIR" | sed 's|^/mnt/c|/c|' | sed 's|^/c|/mnt/c|')
        timeout 10s wsl -e bash -c "cd '$WSL_PATH' && npx lint-staged"
        ;;
esac

# Check if timeout occurred
if [ $? -eq 124 ]; then
    echo ""
    echo "‚ùå VALIDATION TIMEOUT (10 seconds)"
    echo "üí° Syntax error detected - ESLint cannot parse your code"
    echo "üí° Fix syntax errors first, then commit"
    echo ""
    exit 1
fi
