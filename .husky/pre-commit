#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "üîç PRE-COMMIT VALIDATION (MANDATORY)"
echo "===================================="
echo ""
echo "‚ö†Ô∏è  CRITICAL REQUIREMENT: ESLint validation MUST pass before commit"
echo "   - Code quality enforced at commit time ONLY"
echo "   - Deployments focus on build validation for faster cycles"
echo "   - All JavaScript and TypeScript files in bin/, lib/, lambda/"
echo "   - TypeScript-specific rules enforced"
echo "   - Comment standards enforced (JSDoc)"
echo "   - Zero warnings tolerance"
echo ""

# Run comprehensive ESLint validation
echo "üîç Running comprehensive ESLint validation..."
echo "   - Validating ALL JavaScript and TypeScript files"
echo "   - Enforcing code quality standards"
echo ""

# Use the current shell's PATH to find npm
export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"

# Try different ways to run npm
if command -v npm >/dev/null 2>&1; then
    NPM_CMD="npm"
elif [ -f "/usr/bin/npm" ]; then
    NPM_CMD="/usr/bin/npm"
elif [ -f "/usr/local/bin/npm" ]; then
    NPM_CMD="/usr/local/bin/npm"
else
    echo "‚ùå ERROR: npm command not found"
    echo "Please ensure Node.js and npm are properly installed"
    exit 1
fi

if ! $NPM_CMD run precommit; then
    echo ""
    echo "‚ùå COMMIT BLOCKED: ESLint validation failed"
    echo "=========================================="
    echo ""
    echo "üö® CRITICAL: Code quality standards not met"
    echo ""
    echo "Required actions before committing:"
    echo "1. Fix all ESLint errors shown above"
    echo "2. Ensure all functions have proper JSDoc comments"
    echo "3. Use proper TypeScript best practices"
    echo ""
    echo "üîß Quick fix commands:"
    echo "   npm run lint:fix    # Auto-fix ESLint issues"
    echo "   npm run lint        # Check remaining ESLint issues"
    echo ""
    echo "üí° Common ESLint fixes needed:"
    echo "   - Add JSDoc comments to functions"
    echo "   - Fix TypeScript type annotations"
    echo "   - Correct indentation and formatting"
    echo "   - Use proper parameter and return documentation"
    echo ""
    exit 1
fi

echo ""
echo "‚úÖ ALL PRE-COMMIT CHECKS PASSED!"
echo "================================"
echo "   ‚úÖ ESLint validation: PASSED (MANDATORY)"
echo "   ‚úÖ Code quality standards: MET"
echo "   ‚úÖ Comment standards: ENFORCED"
echo ""
echo "üéâ Commit approved - proceeding..."
echo "üí° Note: Deployments will focus on build validation only"
echo ""
